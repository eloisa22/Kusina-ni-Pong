<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kusina ni Daddy Pong</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700;900&family=Tapestry&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Rubik', sans-serif; background: linear-gradient(black, white); padding: 10px; display: flex; justify-content: center; min-height: 100vh; margin: 0; }
        .container { background: white; width: 100%; max-width: 850px; border-radius: 15px; box-shadow: 0 2px 2px 5px #FFD150; overflow: hidden; height: fit-content; margin-top: 20px;}
        .header { background: #d63031; color: #FFD150; padding: 20px; text-align: center; }
        .logo { width: 80px; height: auto; border-radius: 50%; margin-bottom: 10px; }
        .header h1 { margin: 0; font-family: "Tapestry", serif; font-size: 28px; }
        .tabs { display: flex; background: #f1f2f6; border-bottom: 2px solid #dfe6e9; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; font-weight: 900; color: #636e72; cursor: pointer; text-transform: uppercase; font-size: 14px; }
        .tab-btn.active { color: #d63031; border-bottom: 4px solid #d63031; background: white; }
        .page { display: none; padding: 20px; }
        .page.active { display: block; }
        .form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        .prod-col { grid-column: span 1; width: 135%; }
        .qty-col { grid-column: span 1; width: 60%; justify-self: end; }
        label { font-size: 12px; font-weight: 700; color: #636e72; text-transform: uppercase; margin-bottom: 5px; display: block; }
        input, select { font-family: 'Rubik', sans-serif; width: 100%; padding: 12px; border: 2px solid #dfe6e9; border-radius: 10px; font-size: 18px; box-sizing: border-box; }
        #qtyMsg { color: #d63031; font-size: 11px; font-weight: bold; margin-top: 4px; }
        .btn-add { background: #d63031; width: 100%; margin-top: 20px; padding: 15px; color: white; border: none; border-radius: 10px; font-weight: 900; cursor: pointer; box-shadow: 0 4px #b02626; }
        .btn-add:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }
        .table-controls { display: flex; gap: 10px; margin-bottom: 15px; }
        #searchBox { flex: 2; }
        .btn-excel { flex: 1; background: #27ae60; color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; }
        .table-area { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th { text-align: left; font-size: 11px; border-bottom: 2px solid #eee; padding: 10px; color: #b2bec3; text-transform: uppercase; }
        td { padding: 12px 10px; border-bottom: 1px solid #f1f2f6; font-size: 14px; }
        .paid-chk { transform: scale(1.5); cursor: pointer; }
        .paid-row { background-color: #f0fff4; color: #d63031; font-weight: bold; }
        .del-btn { background: none; border: none; color: #636e72; cursor: pointer; font-size: 18px; }
        .total-section { margin-top: 20px; padding: 15px; text-align: right; background: #f9f9f9; font-size: 22px; font-weight: 900; color: #d63031; border-radius: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="logo.png" alt="Logo" class="logo">
        <h1>Kusina ni Daddy Pong</h1>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openPage('addPage', this)">Add Order</button>
        <button class="tab-btn" onclick="openPage('logPage', this)">Sales Log</button>
    </div>
    
    <div id="addPage" class="page active">
        <div class="form">
            <div class="full-width">
                <label>Buyer's Name</label>
                <input type="text" id="buyerName" placeholder="Enter Name">
            </div>
            <div class="prod-col">
                <label>Product</label>
                <select id="prod">
                    <option value="160">Chicken Roll (Ham) - ‚Ç±160</option>
                    <option value="160">Chicken Roll (Hotdog) - ‚Ç±160</option>
                    <option value="160">Chicken Pastil (Spicy) - ‚Ç±160</option>
                    <option value="150">Chicken Pastil (Original) - ‚Ç±150</option>
                    <option value="180">Pork Humba - ‚Ç±180</option>
                    <option value="170">Kinamatisang Dilis - ‚Ç±170</option>
                    <option value="180">Pork Binagoongan (Sweet) - ‚Ç±180</option>
                    <option value="180">Pork Binagoongan (Sweet & Spicy) - ‚Ç±180</option>
                    <option value="150">Binagoongan - ‚Ç±150</option>
                </select>
            </div>
            <div class="qty-col">
                <label>Qty</label>
                <input type="number" id="qty" value="0" min="0">
                <span id="qtyMsg">‚ö†Ô∏è Add quantity</span>
            </div>
        </div>
        <button class="btn-add" id="addBtn" disabled>ADD ENTRY</button>
    </div>

    <div id="logPage" class="page">
        <div class="table-controls">
            <input type="text" id="searchBox" placeholder="Search name...">
            <button class="btn-excel" id="excelBtn">EXCEL</button>
        </div>

        <div class="table-area">
            <table>
                <thead>
                    <tr><th>Paid</th><th>Name</th><th>Item</th><th>Qty</th><th>Total</th><th></th></tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
        <div class="total-section">
            Grand Total: ‚Ç±<span id="grandDisplay">0</span>
        </div>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, push, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDA_Xr94im77KKizIz5IBB3FeGweCP1Egc",
    authDomain: "food-admin2.firebaseapp.com",
    databaseURL: "https://food-admin2-default-rtdb.firebaseio.com",
    projectId: "food-admin2",
    storageBucket: "food-admin2.firebasestorage.app",
    messagingSenderId: "1007400386429",
    appId: "1:1007400386429:web:2778b245d782f72ec3d614"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const ordersRef = ref(db, 'orders');

  const productData = [
      { name: "Chicken Roll (Ham)", price: 160 },
      { name: "Chicken Roll (Hotdog)", price: 160 },
      { name: "Chicken Pastil (Spicy)", price: 160 },
      { name: "Chicken Pastil (Original)", price: 150 },
      { name: "Pork Humba", price: 180 },
      { name: "Kinamatisang Dilis", price: 170 },
      { name: "Pork Binagoongan (Sweet)", price: 180 },
      { name: "Pork Binagoongan (Sweet & Spicy)", price: 180 },
      { name: "Binagoongan", price: 150 }
  ];

  const MY_PASS = "Bukatot@18";

  window.openPage = function(pageId, btn) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
      btn.classList.add('active');
  }

  function validateForm() {
      const buyerInput = document.getElementById('buyerName');
      const qtyInput = document.getElementById('qty');
      const addBtn = document.getElementById('addBtn');
      const qtyMsg = document.getElementById('qtyMsg');
      const nameOk = buyerInput.value.trim().length > 0;
      const qtyVal = parseInt(qtyInput.value);
      qtyMsg.style.display = (qtyVal > 0) ? "none" : "block";
      addBtn.disabled = !(nameOk && qtyVal > 0);
  }
  document.getElementById('buyerName').addEventListener('input', validateForm);
  document.getElementById('qty').addEventListener('input', validateForm);

  document.getElementById('addBtn').addEventListener('click', async () => {
      const buyerInput = document.getElementById('buyerName');
      const qtyInput = document.getElementById('qty');
      const prodSelect = document.getElementById('prod');
      const name = buyerInput.value.trim();
      const itemName = prodSelect.options[prodSelect.selectedIndex].text.split(" - ")[0];
      const price = parseInt(prodSelect.value);
      const quantity = parseInt(qtyInput.value);

      try {
          const snapshot = await get(ordersRef);
          const data = snapshot.val();
          let existingKey = null;
          let oldQty = 0;

          if (data) {
              for (let key in data) {
                  if (data[key].name.toLowerCase() === name.toLowerCase() && data[key].item === itemName && !data[key].paid) {
                      existingKey = key;
                      oldQty = data[key].qty;
                      break;
                  }
              }
          }

          if (existingKey) {
              const newQty = oldQty + quantity;
              await update(ref(db, `orders/${existingKey}`), {
                  qty: newQty,
                  total: newQty * price,
                  timestamp: new Date().toLocaleString()
              });
          } else {
              await push(ordersRef, {
                  name: name, item: itemName, qty: quantity, total: price * quantity, paid: false, timestamp: new Date().toLocaleString()
              });
          }
          buyerInput.value = "";
          qtyInput.value = 0;
          validateForm();
          alert("Order Recorded!");
      } catch (err) { alert("Error: " + err.message); }
  });

  onValue(ordersRef, (snapshot) => {
      renderTable(snapshot.val(), document.getElementById('searchBox').value);
  });

  document.getElementById('searchBox').addEventListener('input', () => {
      get(ordersRef).then(snapshot => renderTable(snapshot.val(), document.getElementById('searchBox').value));
  });

  function renderTable(data, filter = "") {
      const tbody = document.getElementById('tbody');
      let grandTotal = 0;
      tbody.innerHTML = "";
      if (data) {
          Object.entries(data).reverse().forEach(([key, order]) => {
              if (order.name.toLowerCase().includes(filter.toLowerCase())) {
                  grandTotal += order.total;
                  const rowClass = order.paid ? "class='paid-row'" : "";
                  tbody.innerHTML += `<tr ${rowClass}>
                      <td><input type="checkbox" class="paid-chk" data-id="${key}" ${order.paid ? 'checked' : ''}></td>
                      <td>${order.name}</td>
                      <td><b>${order.item}</b></td>
                      <td>${order.qty}</td>
                      <td>‚Ç±${order.total.toLocaleString()}</td>
                      <td><button class="del-btn" onclick="deleteEntry('${key}')">üóëÔ∏è</button></td>
                  </tr>`;
              }
          });
      }
      document.getElementById('grandDisplay').innerText = grandTotal.toLocaleString();
      document.querySelectorAll('.paid-chk').forEach(chk => {
          chk.onchange = async () => { update(ref(db, `orders/${chk.dataset.id}`), { paid: chk.checked }); };
      });
  }

  window.deleteEntry = function(key) {
      if (prompt("Enter Password to DELETE:") === MY_PASS) { remove(ref(db, 'orders/' + key)); }
      else { alert("Incorrect Password!"); }
  };

  // EXCEL EXPORT
  document.getElementById('excelBtn').addEventListener('click', () => {
      get(ordersRef).then(snapshot => {
          const data = snapshot.val();
          if(!data) return alert("No data!");

          const orders = Object.values(data);
          const startRow = 3; 
          const endRow = startRow + orders.length - 1;
          const totalColLetter = String.fromCharCode(68 + productData.length); 

          let tableHtml = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
            <head><meta charset="UTF-8"></head>
            <body>
            <table border="1">
                <tr style="display:none;">
                    <td colspan="3">Unit Prices</td>
                    ${productData.map(p => `<td>${p.price}</td>`).join('')}
                    <td></td>
                </tr>
                <tr style="background-color: #d63031; color: #FFD150; font-weight: bold;">
                    <th>Date</th>
                    <th>Status</th>
                    <th>Buyer Name</th>
                    ${productData.map(p => `<th>${p.name}<br>(‚Ç±${p.price})</th>`).join('')}
                    <th>ORDER TOTAL</th>
                </tr>
          `;

          orders.forEach((o, index) => {
              const statusText = o.paid ? "PAID" : "UNPAID";
              let rowItemsHtml = productData.map(p => {
                  let val = (o.item === p.name) ? o.qty : "";
                  return `<td align="center">${val}</td>`;
              }).join('');

              tableHtml += `
                <tr>
                    <td>${o.timestamp}</td>
                    <td>${statusText}</td>
                    <td>${o.name}</td>
                    ${rowItemsHtml}
                    <td align="right">${o.total}</td>
                </tr>
              `;
          });

          tableHtml += `<tr><td colspan="${productData.length + 4}"></td></tr>`;
          
          let itemSalesFormulas = productData.map((p, i) => {
              let colLetter = String.fromCharCode(68 + i);
              return `<td align="center" style="font-weight:bold;">=SUM(${colLetter}${startRow}:${colLetter}${endRow})*${colLetter}1</td>`;
          }).join('');

          tableHtml += `
            <tr style="background-color: #f1f2f6; color: #d63031; font-weight: bold;">
                <td colspan="3" align="right">TOTAL SALES PER ITEM (PHP):</td>
                ${itemSalesFormulas}
                <td></td>
            </tr>
          `;

          const spanCount = productData.length + 3;
          let paidFormula = `=SUMIF(B${startRow}:B${endRow},"PAID",${totalColLetter}${startRow}:${totalColLetter}${endRow})`;
          let unpaidFormula = `=SUMIF(B${startRow}:B${endRow},"UNPAID",${totalColLetter}${startRow}:${totalColLetter}${endRow})`;
          let overallFormula = `=SUM(${totalColLetter}${startRow}:${totalColLetter}${endRow})`;

          tableHtml += `
            <tr><td colspan="${productData.length + 4}"></td></tr>
            <tr style="color: #27ae60; font-weight: bold;"><td colspan="${spanCount}" align="right">TOTAL COLLECTED (PAID):</td><td align="right">${paidFormula}</td></tr>
            <tr style="color: #d63031; font-weight: bold;"><td colspan="${spanCount}" align="right">TOTAL PENDING (UNPAID):</td><td align="right">${unpaidFormula}</td></tr>
            <tr style="background-color: #FFD150; font-weight: bold;"><td colspan="${spanCount}" align="right">OVERALL TOTAL SALES:</td><td align="right">${overallFormula}</td></tr>
          `;

          tableHtml += `</table></body></html>`;

          const blob = new Blob([tableHtml], { type: 'application/vnd.ms-excel' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = "Daddy_Pong_Orders.xls";
          a.click();
      });
  });
</script>

</body>
</html>
